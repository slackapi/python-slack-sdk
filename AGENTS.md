# AGENTS.md — Python Slack SDK

## Project Overview

The Python Slack SDK (`slack_sdk`) is a modular Python library for interacting with the Slack platform APIs. It is published on PyPI as `slack-sdk`. The SDK provides independent packages for each Slack API surface: Web API, Webhooks, Socket Mode, OAuth, Audit Logs, SCIM, RTM, Block Kit models, and request signature verification.

- **Repository**: <https://github.com/slackapi/python-slack-sdk>
- **Documentation**: <https://docs.slack.dev/tools/python-slack-sdk/>
- **PyPI**: <https://pypi.org/project/slack-sdk/>
- **Current version**: defined in `slack_sdk/version.py`

## Critical Rules

These are the most important constraints in this project. Violating any of them will break CI or corrupt auto-generated code:

1. **Never edit auto-generated files.** The following files are produced by `scripts/codegen.py` and must not be modified directly:
   - `slack_sdk/web/async_client.py`
   - `slack_sdk/web/legacy_client.py`
   - `slack_sdk/web/async_chat_stream.py`

   Edit the source files (`client.py` or `chat_stream.py`) instead, then run codegen (see [Code Generation](#code-generation-critical-pattern)).

2. **Zero runtime dependencies.** The core sync Web API client must have no required runtime dependencies. Do not add entries to `install_requires` / `dependencies` in `pyproject.toml`.

3. **Do not modify the legacy `slack/` package.** It is in maintenance mode and only re-exports from `slack_sdk` with deprecation warnings. All new development goes in `slack_sdk/`.

4. **Always run codegen + format after editing `client.py` or `chat_stream.py`:**

   ```sh
   python scripts/codegen.py --path .
   ./scripts/format.sh
   ```

5. **Use project scripts, not raw tool commands.** Run `./scripts/run_tests.sh`, not `pytest` directly. The scripts handle codegen and formatting.

## Architecture

### Package Structure

```text
slack_sdk/                  # Main package (active development)
├── web/                    # Web API client (sync, async, legacy)
│   ├── client.py           # *** CANONICAL SOURCE — edit this file ***
│   ├── async_client.py     # AUTO-GENERATED from client.py (do not edit)
│   ├── legacy_client.py    # AUTO-GENERATED from client.py (do not edit)
│   ├── base_client.py      # Sync HTTP transport (urllib)
│   ├── async_base_client.py  # Async HTTP transport (aiohttp)
│   ├── legacy_base_client.py
│   ├── slack_response.py   # Response wrapper (sync)
│   ├── async_slack_response.py
│   ├── chat_stream.py      # Streaming chat (edit this file)
│   ├── async_chat_stream.py  # AUTO-GENERATED from chat_stream.py (do not edit)
│   └── internal_utils.py   # Shared helpers
├── webhook/                # Incoming Webhooks & response_url
├── socket_mode/            # Socket Mode (multiple backend implementations)
│   ├── builtin/            # Built-in WebSocket (no extra deps)
│   ├── aiohttp/            # aiohttp backend
│   ├── websocket_client/   # websocket-client backend
│   └── websockets/         # websockets backend
├── oauth/                  # OAuth V2 + OpenID Connect flows
│   ├── installation_store/ # Token storage (file, SQLAlchemy, S3, etc.)
│   ├── state_store/        # OAuth state management
│   └── token_rotation/     # Token refresh logic
├── models/                 # Block Kit UI builders
│   ├── blocks/             # Block elements
│   ├── views/              # Modal views
│   ├── attachments/        # Legacy attachments
│   └── metadata/           # Event/entity metadata
├── audit_logs/v1/          # Audit Logs API client
├── scim/v1/                # SCIM API client
├── signature/              # Request signature verification
├── http_retry/             # HTTP retry handlers (builtin sync + async)
├── rtm_v2/                 # Real-time messaging (legacy)
├── errors/                 # Exception types
└── version.py              # Single source of truth for version

slack/                      # Legacy package (maintenance mode, do not modify)
```

### Code Generation (Critical Pattern)

The SDK uses code generation to maintain sync/async/legacy variants from a single source of truth. This is the most important pattern to understand:

1. **`slack_sdk/web/client.py`** is the canonical source for all Web API methods
2. **`scripts/codegen.py`** transforms `client.py` into:
   - `async_client.py` — adds `async def`, `await`, replaces classes with async variants
   - `legacy_client.py` — adds `Union[Future, SlackResponse]` return types
3. Similarly, `chat_stream.py` generates `async_chat_stream.py`

**Never edit auto-generated files directly.** They contain a header:

```text
# DO NOT EDIT THIS FILE
# 1) Modify slack_sdk/web/client.py
# 2) Run `python scripts/codegen.py`
# 3) Run `black slack_sdk/`
```

After editing `client.py` or `chat_stream.py`, always run:

```sh
python scripts/codegen.py --path .
./scripts/format.sh
```

### Web API Method Pattern

Every Web API method in `client.py` follows this pattern:

```python
def method_name(
    self,
    *,                              # keyword-only arguments
    required_param: str,
    optional_param: Optional[str] = None,
    **kwargs,
) -> SlackResponse:
    """Description of the API method
    https://docs.slack.dev/reference/methods/method.name
    """
    kwargs.update({"required_param": required_param})
    if optional_param is not None:
        kwargs.update({"optional_param": optional_param})
    return self.api_call("method.name", params=kwargs)
```

Key conventions:

- All parameters are keyword-only (after `*`)
- Required params have no default; optional params default to `None`
- `**kwargs` captures additional/undocumented parameters
- Parameters are collected into `kwargs` dict and passed to `self.api_call()`
- The `api_call` method name uses Slack's dot-notation (e.g., `"chat.postMessage"`)
- Docstrings include a link to the Slack API reference

### Error Types

Defined in `slack_sdk/errors/__init__.py`:

| Exception | When raised |
| --- | --- |
| `SlackClientError` | Base class for all client errors |
| `SlackApiError` | Invalid API response (carries the `response` object) |
| `SlackRequestError` | Problem submitting the request |
| `BotUserAccessError` | `xoxb` token used for a `xoxp`-only method |
| `SlackTokenRotationError` | `oauth.v2.access` token rotation failure |
| `SlackClientNotConnectedError` | WebSocket operation while disconnected |
| `SlackObjectFormationError` | Malformed Block Kit or other SDK objects |
| `SlackClientConfigurationError` | Invalid client-side configuration |

### HTTP Retry Handlers

The `slack_sdk/http_retry/` module provides built-in retry strategies:

- **`ConnectionErrorRetryHandler`** / **`AsyncConnectionErrorRetryHandler`** — retries on connection errors
- **`RateLimitErrorRetryHandler`** / **`AsyncRateLimitErrorRetryHandler`** — retries on HTTP 429 (respects `Retry-After`)
- **`ServerErrorRetryHandler`** / **`AsyncServerErrorRetryHandler`** — retries on HTTP 500/503

Retry interval is configurable via `BackoffRetryIntervalCalculator` (exponential backoff) or `FixedValueRetryIntervalCalculator`.

### Test Patterns

Tests use `unittest.TestCase` with a mock web API server:

```python
import unittest
from slack_sdk import WebClient
from tests.slack_sdk.web.mock_web_api_handler import MockHandler
from tests.mock_web_api_server import setup_mock_web_api_server, cleanup_mock_web_api_server

class TestFeature(unittest.TestCase):
    def setUp(self):
        setup_mock_web_api_server(self, MockHandler)
        self.client = WebClient(
            token="xoxb-api_test",
            base_url="http://localhost:8888",
        )

    def tearDown(self):
        cleanup_mock_web_api_server(self)

    def test_something(self):
        resp = self.client.api_test()
        self.assertTrue(resp["ok"])
```

Each sub-package has its own `MockHandler` (e.g., `tests/slack_sdk/webhook/mock_web_api_handler.py`, `tests/slack_sdk/scim/mock_web_api_handler.py`). Use the handler from the matching sub-package.

Test directories:

- `tests/` — Unit tests (mirroring `slack_sdk/` structure)
  - `tests/slack_sdk/` — Sync tests
  - `tests/slack_sdk_async/` — Async variants
  - `tests/slack_sdk_fixture/` — Pytest fixtures and test data
  - `tests/data/` — JSON fixture files
  - `tests/mock_web_api_server/` — Mock Slack API server
- `integration_tests/` — Tests against real Slack APIs (require env tokens)

## Development Commands

### Setup

A python virtual environment (`venv`) MUST be activated before running any commands. You can verify that the virtual environment is active by checking if the `$VIRTUAL_ENV` environment variable is set with `echo $VIRTUAL_ENV`.
If tools like `black`, `flake8`, `mypy`, or `pytest` are not found, ask the user to activate the venv.

Always use the project scripts instead of calling tools like `pytest` directly.

### Install Dependencies

```sh
./scripts/install.sh
```

Installs all project dependencies (testing, optional, and tools) via pip. This script is called automatically by `run_validation.sh`, `run_integration_tests.sh`, and `run_mypy.sh`, so you typically don't need to run it separately.

### Full Validation

```sh
./scripts/run_validation.sh
```

This is the canonical check — CI runs this and the PR template asks contributors to run it. It installs requirements, runs codegen, formats, lints, runs tests with coverage, and runs mypy type checking on Python 3.14.

### Individual Commands

| Task                        | Command                                                              |
| --------------------------- | -------------------------------------------------------------------- |
| Install dependencies        | `./scripts/install.sh`                                               |
| Uninstall all packages      | `./scripts/uninstall_all.sh`                                         |
| Format code                 | `./scripts/format.sh`                                                |
| Lint (check formatting)     | `./scripts/lint.sh`                                                  |
| Run all unit tests          | `./scripts/run_tests.sh`                                             |
| Run a specific test         | `./scripts/run_tests.sh tests/slack_sdk/web/test_web_client.py`      |
| Run type checking           | `./scripts/run_mypy.sh`                                              |
| Generate async/legacy code  | `python scripts/codegen.py --path .`                                 |
| Build PyPI package          | `./scripts/build_pypi_package.sh`                                    |
| Generate API docs           | `./scripts/generate_api_docs.sh`                                     |

## Code Style & Tooling

- **Formatter**: `black` (line length: 125, version pinned in `requirements/tools.txt`)
- **Linter**: `flake8` (line length: 125, configured in `.flake8`)
- **Type checker**: `mypy` (configured in `pyproject.toml`, excludes `scim/` and `rtm/`)
- **Test runner**: `pytest` with `pytest-asyncio` (asyncio_mode = "auto")
- **Coverage**: `pytest-cov` reporting to Codecov
- **Build system**: `setuptools` via `pyproject.toml`

## CI Pipeline (GitHub Actions)

Defined in `.github/workflows/ci-build.yml`, runs on push to `main`, all PRs, and daily schedule. Check the workflow file for the current Python version matrix.

## Key Files

| File                                | Purpose                                                  |
| ----------------------------------- | -------------------------------------------------------- |
| `slack_sdk/version.py`              | Single source of truth for package version               |
| `slack_sdk/web/client.py`           | Canonical Web API client (~200+ methods)                 |
| `slack_sdk/web/chat_stream.py`      | Canonical streaming chat client                          |
| `scripts/codegen.py`                | Code generator for async/legacy client variants          |
| `pyproject.toml`                    | Project config (build, black, pytest, mypy settings)     |
| `.flake8`                           | Flake8 linting config                                    |
| `requirements/testing.txt`          | Test dependencies                                        |
| `requirements/optional.txt`         | Optional runtime dependencies (aiohttp, SQLAlchemy, etc) |
| `requirements/tools.txt`            | Dev tools (black, flake8, mypy)                          |
| `.github/workflows/ci-build.yml`    | CI pipeline definition                                   |
| `.github/maintainers_guide.md`      | Maintainer workflows and release process                 |

## Common Contribution Workflows

### Adding a New Web API Method

1. Add the method to `slack_sdk/web/client.py` following the existing pattern
2. Run code generation: `python scripts/codegen.py --path .`
3. Run formatter: `./scripts/format.sh`
4. Add tests in `tests/slack_sdk/web/`
5. Validate: `./scripts/run_validation.sh`

### Adding a New Feature to a Non-Web Module

1. Implement the sync version in the appropriate `slack_sdk/` subpackage
2. If the module has async variants, implement those as well (not auto-generated for non-web modules)
3. Add tests mirroring the module structure
4. Validate: `./scripts/run_validation.sh`

### Fixing a Bug

1. Write a test that reproduces the bug
2. Fix the code (if in `client.py`, run codegen afterward)
3. Validate: `./scripts/run_validation.sh`

## Versioning & Releases

- Use the new version mentioned by the maintainer; if they do not provide it, prompt them for it.
- Ensure the new version follows [Semantic Versioning](http://semver.org/) via [PEP 440](https://peps.python.org/pep-0440/)
- Version lives in `slack_sdk/version.py` and is dynamically read by `pyproject.toml`
- Releases are triggered by publishing a GitHub Release, which triggers the PyPI deployment workflow; the maintainer will take care of this
- Commit message format for releases: `chore(release): version X.Y.Z`

## Dependencies

The SDK has **zero required runtime dependencies** for the core sync Web API client and it is imperative it remains that way. Optional dependencies enable additional functionality:

- `aiohttp` — async HTTP client
- `websockets` / `websocket-client` — Socket Mode backends
- `SQLAlchemy` — OAuth token storage
- `boto3` — S3/DynamoDB token storage
- `aiodns` — faster DNS resolution for async

Version constraints for optional and dev dependencies are pinned in the `requirements/` directory.
